<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediCart - Admin Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Unlock scrolling for the Admin Page */
        body.auth-page-bg {
            height: auto !important;
            min-height: 100vh;
            overflow-y: auto !important;
            padding-bottom: 50px; 
        }
        /* Premium Admin Panel Styles */
        .admin-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
        }
        .admin-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 30px; max-width: 1200px; margin: 40px auto; padding: 0 20px;}
        .admin-panel h3 { border-bottom: 2px dashed #bdc3c7; padding-bottom: 10px; margin-top: 0; color: #2c3e50; font-size: 1.3rem;}
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; border-radius: 8px; overflow: hidden;}
        th, td { text-align: left; padding: 12px 15px; border-bottom: 1px solid #ecf0f1; font-size: 0.95rem; }
        th { background-color: #3498db; color: white; font-weight: 600;}
        tr:hover { background-color: #f8f9fa; }
        
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
        .pending { background: #ffeeba; color: #856404; }
        
        .action-btn { cursor: pointer; border: none; background: none; font-size: 1.1rem; transition: transform 0.2s;}
        .action-btn:hover { transform: scale(1.2); }
        .edit-btn { color: #f39c12; margin-right: 15px; }
        .delete-btn { color: #e74c3c; }

        /* Scrollbar for lists */
        .scrollable-list { max-height: 400px; overflow-y: auto; padding-right: 10px;}
        
        /* Edit Mode Alert */
        #edit-alert { display: none; background: #f39c12; color: white; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-weight: bold; font-size: 0.9rem; text-align: center; }
    </style>
</head>
<body class="auth-page-bg"> <nav class="navbar">
        <div class="logo">MediCart <span>Admin</span></div>
        <div class="nav-user">
            <a href="home.html" style="color: white; margin-right: 20px; font-weight: bold; text-decoration: none;"><i class="fas fa-store"></i> View Shop</a>
            <a href="#" class="logout-btn" onclick="logout()">Logout</a>
        </div>
    </nav>

    <div id="toast-container"></div>

    <div class="admin-grid fade-in-up">
        
        <div class="admin-panel">
            <h3><i class="fas fa-box" style="color: #3498db; margin-right: 8px;"></i> <span id="form-title">Add New Medicine</span></h3>
            
            <div id="edit-alert"><i class="fas fa-pen"></i> Editing Mode Active</div>

            <form id="add-product-form">
                <input type="hidden" id="edit-id">

                <div class="form-group icon-input">
                    <i class="fas fa-pills"></i>
                    <input type="text" id="p-name" class="form-input" required placeholder="Medicine Name">
                </div>
                <div class="form-group icon-input">
                    <i class="fas fa-rupee-sign"></i>
                    <input type="number" id="p-price" class="form-input" required placeholder="Price">
                </div>
                <div class="form-group icon-input">
                    <i class="fas fa-tags"></i>
                    <select id="p-category" class="form-input category-select" title="Select a category">
                        <option value="General">General</option>
                        <option value="Pain Relief">Pain Relief</option>
                        <option value="Supplements">Supplements</option>
                        <option value="Syrup">Syrup</option>
                        <option value="Diabetes">Diabetes</option>
                        <option value="Safety">Safety</option>
                    </select>
                </div>
                <div class="form-group icon-input">
                    <i class="fas fa-image"></i>
                    <input type="text" id="p-image" class="form-input" placeholder="Image URL (e.g. https://...)" required>
                </div>
                
                <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="p-rx" style="width: 18px; height: 18px; cursor: pointer;">
                    <label for="p-rx" style="margin: 0; color: #2c3e50; font-weight: bold; cursor: pointer; color: #e74c3c;">⚕️ Requires Prescription</label>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button type="submit" id="submit-btn" class="auth-btn glow-btn" style="flex: 2;">Add Product</button>
                    <button type="button" id="cancel-btn" class="auth-btn" style="flex: 1; background: #95a5a6; display: none;" onclick="cancelEdit()">Cancel</button>
                </div>
            </form>
        </div>

        <div style="display: flex; flex-direction: column; gap: 30px;">
            
            <div class="admin-panel">
                <h3><i class="fas fa-list" style="color: #3498db; margin-right: 8px;"></i> Manage Products</h3>
                <div id="admin-product-list" class="scrollable-list">
                    </div>
            </div>

            <div class="admin-panel">
                <h3><i class="fas fa-shopping-cart" style="color: #27ae60; margin-right: 8px;"></i> Recent Orders</h3>
                <div class="scrollable-list">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Items</th>
                                <th>Total</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table">
                            </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // 1. Fetch & Render All Orders
        async function loadAdminOrders() {
            const table = document.getElementById('orders-table');
            try {
                const res = await fetch('/api/orders/all'); 
                const orders = await res.json();
                
                table.innerHTML = '';
                if(orders.length === 0) {
                    table.innerHTML = '<tr><td colspan="5" style="text-align:center;">No orders found.</td></tr>';
                    return;
                }

                orders.forEach(order => {
                    const date = new Date(order.date).toLocaleDateString();
                    const itemSummary = order.items.map(i => `${i.name} (x${i.quantity})`).join('<br>');
                    
                    const row = `
                        <tr>
                            <td>${date}</td>
                            <td><strong>${order.shippingAddress.fullName}</strong><br><small style="color:#7f8c8d;">${order.userEmail}</small></td>
                            <td style="font-size: 0.85rem;">${itemSummary}</td>
                            <td style="color:#27ae60; font-weight:bold;">₹${order.totalAmount}</td>
                            <td><span class="status-badge pending">${order.status}</span></td>
                        </tr>
                    `;
                    table.innerHTML += row;
                });
            } catch (err) {
                console.error("Error loading orders", err);
            }
        }

        // 2. Load & Render Products (WITH EDIT BUTTON)
        async function loadAdminProducts() {
            const container = document.getElementById('admin-product-list');
            try {
                const res = await fetch('/api/products');
                const products = await res.json();
                
                container.innerHTML = '';
                products.forEach(p => {
                    const rxBadge = p.requiresRx ? '<span style="color:#e74c3c; font-size:0.7rem; font-weight:bold; margin-left:5px;">⚕️ Rx</span>' : '';
                    
                    // Notice we pass all the product data into the editProduct function!
                    const item = `
                        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ecf0f1; padding: 15px 0;">
                            <div style="display:flex; align-items:center; gap:15px;">
                                <div style="background:white; padding:5px; border-radius:8px; border:1px solid #eee;">
                                    <img src="${p.image}" width="50" height="50" style="object-fit:contain;">
                                </div>
                                <div>
                                    <strong style="color:#2c3e50; font-size:1.05rem;">${p.name} ${rxBadge}</strong><br>
                                    <small style="color:#7f8c8d; font-weight:bold;">₹${p.price} &nbsp;|&nbsp; ${p.category}</small>
                                </div>
                            </div>
                            <div>
                                <button class="action-btn edit-btn" title="Edit Product" onclick="editProduct('${p._id}', '${p.name.replace(/'/g, "\\'")}', ${p.price}, '${p.category}', '${p.image}', ${p.requiresRx})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn delete-btn" title="Delete Product" onclick="deleteProduct('${p._id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    container.innerHTML += item;
                });
            } catch (err) {
                console.error("Error loading products", err);
            }
        }

        // 3. EDIT LOGIC - Puts data into the form
        function editProduct(id, name, price, category, image, requiresRx) {
            document.getElementById('edit-id').value = id;
            document.getElementById('p-name').value = name;
            document.getElementById('p-price').value = price;
            document.getElementById('p-category').value = category;
            document.getElementById('p-image').value = image;
            document.getElementById('p-rx').checked = requiresRx;

            // Update UI for Edit Mode
            document.getElementById('form-title').innerText = "Edit Medicine";
            document.getElementById('submit-btn').innerText = "Update Product";
            document.getElementById('submit-btn').style.background = "linear-gradient(135deg, #f39c12, #e67e22)";
            document.getElementById('submit-btn').style.boxShadow = "0 5px 15px rgba(243, 156, 18, 0.4)";
            document.getElementById('cancel-btn').style.display = "block";
            document.getElementById('edit-alert').style.display = "block";
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // 4. CANCEL EDIT LOGIC
        function cancelEdit() {
            document.getElementById('add-product-form').reset();
            document.getElementById('edit-id').value = "";
            
            // Restore UI for Add Mode
            document.getElementById('form-title').innerText = "Add New Medicine";
            document.getElementById('submit-btn').innerText = "Add Product";
            document.getElementById('submit-btn').style.background = "linear-gradient(135deg, #3498db, #2980b9)";
            document.getElementById('submit-btn').style.boxShadow = "0 5px 15px rgba(52, 152, 219, 0.4)";
            document.getElementById('cancel-btn').style.display = "none";
            document.getElementById('edit-alert').style.display = "none";
        }

        // 5. SUBMIT FORM (Handles both ADD and UPDATE)
        document.getElementById('add-product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const editId = document.getElementById('edit-id').value;
            
            // Collects data and forces price to be a strict Number
            const productData = {
                name: document.getElementById('p-name').value,
                price: parseFloat(document.getElementById('p-price').value), 
                category: document.getElementById('p-category').value,
                image: document.getElementById('p-image').value,
                requiresRx: document.getElementById('p-rx').checked
            };

            try {
                let res;
                if (editId) {
                    // IF WE HAVE AN ID, UPDATE THE PRODUCT (PUT)
                    res = await fetch(`/api/products/${editId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(productData)
                    });
                } else {
                    // IF NO ID, ADD A NEW PRODUCT (POST)
                    res = await fetch('/api/products/add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(productData)
                    });
                }
                
                if (res.ok) {
                    showToast(editId ? "Product Updated Successfully!" : "Product Added!", "success");
                    cancelEdit(); // Clears the form and resets to Add mode
                    loadAdminProducts(); // Refresh the list
                } else {
                    // If it fails, catch the exact error message and show it!
                    const errorData = await res.json();
                    showToast("Error: " + (errorData.message || "Failed to update"), "error");
                }
            } catch (err) {
                showToast("Server Connection Error", "error");
            }
        });

        // 6. DELETE PRODUCT
        async function deleteProduct(id) {
            if(!confirm("Permanently delete this product?")) return;
            try {
                await fetch(`/api/products/${id}`, { method: 'DELETE' });
                showToast("Product deleted", "info");
                loadAdminProducts();
            } catch (err) {
                showToast("Error deleting product", "error");
            }
        }

        function logout() {
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        // Initialize Admin Page
        loadAdminOrders();
        loadAdminProducts();
    </script>
</body>
</html>